<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
<!--  &lt;!&ndash; https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP &ndash;&gt;-->
<!--  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'">-->
  <title>Pier Player</title>
  <link rel="stylesheet" href="static/bulma.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@latest/css/materialdesignicons.min.css">
  <script src="https://cdn.jsdelivr.net/npm/vue@2.5.16/dist/vue.js"></script>
</head>
<style>
    body {
        -ms-overflow-style: none; /*スクロールバー非表示（IE・Edge）*/
        scrollbar-width: none; /*スクロールバー非表示（Firefox）*/
    }
    body::-webkit-scrollbar {
        display:none; /*スクロールバー非表示（Chrome・Safari）*/
    }

    img#logo {
        height: 2rem;
        max-width: 100%;
        vertical-align: bottom;
    }

    /*.tabs.is-boxed li.is-active a {*/
    /*    background-color: transparent;*/
    /*}*/
    .tabs li.is-active a {
        color: dimgray;
        font-weight: bold;
    }

    table, th, td {}
    .dragging {background-color: #eee;}
    .is-draggable{cursor: grab;}
    .is-draggable:active {cursor: grabbing;}

    .delete {
        vertical-align: middle;
        background-color: #f1466863;
    }
    .delete:hover {
        background-color: #f14668bb !important;
    }
</style>
<body>
<div id="app">
  <h3 class="title is-3 mx-2 mt-2 mb-0"
      style="white-space: nowrap; overflow-x: hidden; height: 2.5rem">
    <img id="logo" src="static/icon.png">
    Pier Player
    <span class="is-size-7" style="font-weight: normal;">映像ファイルをサブモニタで再生します</span>
    <a href="cgm.html"
       style="vertical-align: bottom"
       class="button is-small is-link is-light is-pulled-right mt-1"
    >CGMモードへ</a>
  </h3>

  <div class="tabs is-boxed is-centered is-fullwidth">
    <ul class="m-1" style="background-color: #f1f5f7">
      <li @click="selectSundayTab()" class="is-active"><a>主日礼拝</a></li>
      <li @click="selectWednesdayTab()"><a>水曜礼拝</a></li>
<!--      <li @click="selectDawnTab()"><a>明け方</a></li>-->
      <li @click="selectOtherTab()"><a>その他</a></li>
    </ul>
  </div>

  <div style="margin: auto; width: fit-content; min-width: 360px; max-width: 100%;">
    <table class="table my-2 is-striped" style="width: 100%;">
      <tbody>
      <tr>
        <td colspan="2">
          <button class="button is-small"
                  @click="storeFileInfo()">保存する</button>
        </td>
        <td>
          <button class="button is-small is-danger"
                  v-if="isPlaying"
                  @click="close()"
          >停止</button>
        </td>
        <td></td>
      </tr>
      <tr
          v-for="(file, i) in files"
          :key="i"
          :draggable="true"
          @dragstart="dragStart(i)"
          @dragenter="dragEnter(i)"
          @dragover.prevent
          @dragend="dragEnd()"
          :class="i === dragIndex ? 'dragging' : ''"
      >
        <td style="width: min-content; white-space: nowrap;">
          <span class="icon ml-0 mr-0 is-draggable">
            <i class="mdi mdi-24px mdi-drag-vertical mt-1"></i>
          </span>
          <span v-if="isVideo(file.type)" class="icon has-text-link">
            <i class="mdi mdi-24px mdi-video"></i>
          </span>
          <span v-if="isAudio(file.type)" class="icon"
                style="color:#eebe3a!important">
            <i class="mdi mdi-24px mdi-music-note"></i>
          </span>
        </td>
        <td style="font-size: 0.9rem; max-width: 30rem; vertical-align: middle; overflow-x: auto">
          <a v-if="isVideo(file.type)" @click="preview(file)">{{ file.name }}</a>
          <span v-if="isAudio(file.type)">{{ file.name }}</span>
        </td>
        <td>
          <button v-if="isExists(file.path)"
                  class="button is-small is-success"
                  @click="play(i)"
          >再生</button>
        </td>
        <td style="width: 1rem">
          <button class="delete" @click="removeRow(i)"></button>
        </td>
      </tr>
      </tbody>
    </table>
    <div class="field is-grouped">
      <div class="file is-small is-link is-light">
        <label class="file-label">
          <input class="file-input" type="file" accept="video/*" @change="selectVideoFile($event)">
          <span class="file-cta">
          <span class="file-label">映像追加</span>
        </span>
        </label>
      </div>
      <div class="file is-small is-warning is-light ml-2">
        <label class="file-label">
          <input class="file-input" type="file" accept="audio/*" @change="selectAudioFile($event)">
          <span class="file-cta">
          <span class="file-label">音源追加</span>
        </span>
        </label>
      </div>
    </div>
<!--    <a class="is-size-7 is-info ml-4" @click="addRow()">行を追加する</a>-->
    <br><br>
    <div class="m-4" style="width: 100%; max-width: 480px;">
      <h6 class="title is-6 mt-4 mb-1">映像プレビュー</h6>
      <div class="box" style="width: 100%; background-color: whitesmoke; aspect-ratio: 16/9">
        <template v-if="previewFile.src">
          <video controls autoplay muted :key="videoReload">
            <source :src="previewFile.src" :type="previewFile.type" />
          </video><br>
          <small>※サブモニターでは再生バーは表示されません。</small>
        </template>
      </div>
    </div>
  </div>
<!--  <br>-->
<!--  <button onclick="window.close()">終了</button>-->
</div>

<script src="static/jquery.js"></script>
<script>
    new Vue({
        el: "#app",
        data: {
            files: [],
            sundayFiles: [{path: "", name: "", type: ""}],
            wednesdayFiles: [{path: "", name: "", type: ""}],
            otherFiles: [{path: "", name: "", type: ""}],
            isPlaying: false,
            selectedTab: "sunday",
            previewFile: { src: "", type: "" },
            dragIndex: null,
            videoReload: 0,
        },
        async created() {
            this.sundayFiles = await window.api.getFiles("sunday");
            this.wednesdayFiles = await window.api.getFiles("wednesday");
            this.otherFiles = await window.api.getFiles("other");
            this.files = this.sundayFiles

            $(document).on("click", ".tabs li", function () {
                $(".tabs li").removeClass("is-active");
                $(this).addClass("is-active");
            })
        },
        mounted() {
            //表示後にやりたいことはここに書ける
        },
        watch: {
            // previewFile: function (newVal) {
            //     this.preview();
            // }
        },
        methods: {
            selectFile(i, event) {
                this.files[i].path = event.target.files[0].path
                this.files[i].name = event.target.files[0].name
                this.files[i].type = event.target.files[0].type
            },
            selectVideoFile(event) {
                this.files.push({
                    path: event.target.files[0].path,
                    name: event.target.files[0].name,
                    type: event.target.files[0].type
                })
            },
            selectAudioFile(event) {
                this.files.push({
                    path: event.target.files[0].path,
                    name: event.target.files[0].name,
                    type: event.target.files[0].type
                })
            },
            isVideo(type) {
                return type.match(/video\/.*/)
            },
            isAudio(type) {
                return type.match(/audio\/.*/)
            },
            play(i) {
                this.isPlaying = true;
                const fileMeta = this.files[i]
                window.api.openSubWindow(fileMeta);
            },
            close() {
                window.api.closeSubWindow();
                this.isPlaying = false
            },
            addRow() {
                this.files.push({path: "", name: "", type: ""})
            },
            removeRow(i) {
                this.files.splice(i, 1);
            },
            preview(file) {
                this.previewFile.src = file.path
                this.previewFile.type = file.type
                this.videoReload++
            },
            async storeFileInfo() {
                window.api.storeFiles(this.selectedTab, this.files);
            },
            selectSundayTab() {
                this.files = this.sundayFiles;
                this.selectedTab = "sunday";
            },
            selectWednesdayTab() {
                this.files = this.wednesdayFiles;
                this.selectedTab = "wednesday";
            },
            selectOtherTab() {
                this.files = this.otherFiles;
                this.selectedTab = "other";
            },
            dragStart(index) {
                this.dragIndex = index;
            },
            dragEnter (index) {
                if (index === this.dragIndex) return;
                const deleteElement = this.files.splice(this.dragIndex, 1)[0];
                this.files.splice(index, 0, deleteElement);
                this.dragIndex = index;
            },
            dragEnd () {
                this.dragIndex = null;
            },
            isExists(v) {
                return typeof v !== 'undefined' && v !== null && v !== "" && v !== {};
            },
        },
    })
</script>
</body>
</html>