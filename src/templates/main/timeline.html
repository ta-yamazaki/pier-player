<!DOCTYPE html>
<html lang="ja" class="has-navbar-fixed-bottom">
<head>
  <meta charset="UTF-8">
  <!--  &lt;!&ndash; https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP &ndash;&gt;-->
  <!--  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'">-->
  <title>Pier Player</title>
  <link rel="stylesheet" href="../../static/css/bulma.css">
  <link rel="stylesheet" href="../../static/css/main.css">
  <link rel="stylesheet" href="../../static/css/timeline.css">
  <link rel="stylesheet" href="../../static/css/side-menu.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@latest/css/materialdesignicons.min.css">
  <script src="https://cdn.jsdelivr.net/npm/vue@2.5.16/dist/vue.js"></script>
</head>
<style>
    .dropArea {
        color: gray;
        font-weight: bold;
        font-size: 0.8rem;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        margin: auto;
        height: 5rem;
        border: 3px solid powderblue;
        background-color: #f2fdff;
        border-radius: 7px;
    }

    .enter {
        color: white;
        background-color: powderblue;
    }

    td {
        vertical-align: middle !important;
    }
</style>
<body>
<div id="appTimeline" v-cloak>
  <aside id="sideMenu"></aside>

  <main>
    <div class="p-4" style="margin: auto;">
<!--      <h5 class="title is-5 my-3">タイムライン</h5>-->
      <div
          class="dropArea"
          @dragenter="dragDropEnter()"
          @dragleave="dragDropLeave()"
          @dragover.prevent
          @drop.prevent="droppedFile($event)"
          :class="{'enter': isEnter}"
      >ドラッグ＆ドロップしてファイルを追加
      </div>
      <p class="help is-danger">{{disallowedFileTypeMessage}}</p>

      <button class="button is-small is-pulled-right mb-3"
              @click="reset()"
      >表示リセット
      </button>

      <table class="table my-2 is-fullwidth borderless">
        <tbody :key="reDraw">
        <tr v-for="(file, i) in files"
            :key="i"
            :class="{'dragging': i === dragIndex}">
          <td :draggable="!playerMeta.isPlaying"
              @dragstart="dragStart(i)"
              @dragenter="dragEnter(i)"
              @dragover.prevent
              @dragend="dragEnd()"
              class="pl-1 pr-0 fitContent"
              style="white-space: nowrap;">
            <span class="icon ml-0 mr-0 is-draggable">
              <i class="mdi mdi-24px mdi-drag-vertical mt-1"></i>
            </span>
          </td>
          <td class="p-1" style="font-size: 0.9rem; overflow-x: auto;">
            <div class="box p-2"
                 :class="{'has-background-success-light': file.isPlaying}">
              <nav class="level is-mobile mb-0">
                <div class="level-left" style="max-width: calc(100% - 55px);">
                    <span v-if="isVideo(file.type)" class="icon has-text-link">
                      <i class="mdi mdi-18px mdi-video"></i>
                    </span>
                  <span v-if="isAudio(file.type)" class="icon" style="color:#eebe3a!important">
                      <i class="mdi mdi-18px mdi-music-note"></i>
                    </span>
                  <b class="is-size-6 mx-2">{{ file.name }}</b>
                  <span v-if="file.exists && file.path"
                        class="icon is-small has-text-grey is-clickable"
                        @click="openFolder(file.path)">
                    <i class="mdi mdi-folder-open"></i>
                  </span>
                </div>
                <div class="level-right">
                  <button v-if="file.exists && !file.isPlaying"
                          class="button is-small is-success"
                          @click="start(i)"
                  ><b>再生</b></button>
                  <br>
                  <button v-if="file.isPlaying"
                          class="button is-small is-danger"
                          @click="close(i)"
                  ><b>停止</b></button>
                </div>
              </nav>
              <p class="has-text-danger mb-0" v-if="!file.exists"
              >ファイルが開けませんでした。ファイルが無いか、アクセスできない場所にあります。</p>

              <!-- プレイヤー -->
              <div v-if="file.isPlaying" class="timelinePlayer">
                <nav class="level is-mobile mb-1">
                  <p>{{ currentTimeColon }}</p>
                  <progress
                      class="mx-2 mb-0"
                      style="cursor: pointer;"
                      :value="playerMeta.currentTime"
                      :max="playerMeta.duration"
                      @mousedown="startSeek"
                  ></progress>
                  <p>{{ durationColon }}</p>
                </nav>

                <nav class="level is-mobile">
                  <p class="level-item">
                    <a class="icon is-clickable has-text-success-dark" @click="restart()">
                      <span class="mdi mdi-24px mdi-skip-previous"/>
                    </a>
                  </p>
                  <p class="level-item">
                    <a class="icon is-clickable has-text-success-dark" @click="rewind(10)">
                      <span class="mdi mdi-24px mdi-rewind-10"/>
                    </a>
                  </p>
                  <p class="level-item">
                    <span v-if="!playerMeta.isPlaying"
                          class="icon is-large is-clickable playIcon"
                          @click="play()">
                      <i class="mdi mdi mdi-48px mdi-play-circle"></i>
                    </span>
                    <span v-if="playerMeta.isPlaying"
                          class="icon is-large is-clickable pauseIcon"
                          @click="pause()">
                      <i class="mdi mdi mdi-48px mdi-pause-circle"></i>
                    </span>
                  </p>
                  <p class="level-item">
                    <a class="icon is-clickable has-text-success-dark" @click="forward(10)">
                      <span class="mdi mdi-24px mdi-fast-forward-10"/>
                    </a>
                  </p>
                  <p class="level-item">
                    <a class="icon is-clickable has-text-success-dark" @click="toEnd()">
                      <span class="mdi mdi-24px mdi-skip-next"/>
                    </a>
                  </p>
                </nav>
              </div>
              <!-- プレイヤーここまで -->
              <!-- 再生編集-->
              <div class="mx-2 mt-2 mb-0">
                <!--            <div class="px-2 py-1 mt-2 mb-0" style="background-color: #f9f9f9">-->
                <div class="is-flex is-align-items-center py-0">
                  <p class="nowrap" style="width: 5rem"></p>
                  <nav class="level is-mobile is-flex-grow-1 is-size-7">
                    <div class="level-left ml-3">開始（秒）</div>
                    <div class="level-right">終了（秒）</div>
                  </nav>
                </div>
                <div class="is-flex is-align-items-center py-1" style="border-bottom: 1px dashed lightgray;">
                  <p class="nowrap" style="width: 5rem">
                    <span class="mdi mdi-content-cut"></span>
                    トリム
                  </p>
                  <nav class="level is-mobile is-flex-grow-1 is-size-7">
                    <div class="level-left">
                      <a @click="decreaseStartTrim(i)"><span class="mdi mdi-minus"></span></a>
                      <input v-model="file.startTrimSec"
                             class="input borderless is-small px-1 py-0 has-text-centered"
                             type="number" min="0" style="width: 2.75rem;height: 1.75em;">
                      <a @click="increaseStartTrim(i)"><span class="mdi mdi-plus"></span></a>
                    </div>
                    <div class="level-right">
                      <a @click="decreaseEndTrim(i)"><span class="mdi mdi-minus"></span></a>
                      <input v-model="file.endTrimSec"
                             class="input borderless is-small px-1 has-text-centered"
                             type="number" min="0" style="width: 2.75rem;height: 1.75em;">
                      <a @click="increaseEndTrim(i)"><span class="mdi mdi-plus"></span></a>
                    </div>
                  </nav>
                </div>
                <div v-if="isVideo(file.type)"
                     class="is-flex is-align-items-center py-1" style="border-bottom: 1px dashed lightgray;">
                  <p class="nowrap" style="width: 5rem">
                    <span class="mdi mdi-square-opacity"></span>
                    フェード
                  </p>
                  <nav class="level is-mobile is-flex-grow-1 is-size-7">
                    <div class="level-left">
                      <a @click="decreaseStartFade(i)"><span class="mdi mdi-minus"></span></a>
                      <input v-model="file.startFadeSec"
                             class="input borderless is-small px-1 py-0 has-text-centered"
                             type="number" min="0" style="width: 2.75rem;height: 1.75em;">
                      <a @click="increaseStartFade(i)"><span class="mdi mdi-plus"></span></a>
                    </div>
                    <div class="level-right">
                      <a @click="decreaseEndFade(i)"><span class="mdi mdi-minus"></span></a>
                      <input v-model="file.endFadeSec"
                             class="input borderless is-small px-1 has-text-centered"
                             type="number" min="0" style="width: 2.75rem;height: 1.75em;">
                      <a @click="increaseEndFade(i)"><span class="mdi mdi-plus"></span></a>
                    </div>
                  </nav>
                </div>
                <div class="py-1">
                  <nav class="level is-mobile is-flex-grow-1">
                    <div class="level-left nowrap">
                      <span class="mdi mdi-volume-high"></span>
                      <input v-model="file.gain"
                             class="is-size-7 ml-2"
                             style="vertical-align: middle"
                             :style="{background: sliderBackground(file.gain)}"
                             step="0.1"
                             :min="gainMin"
                             :max="gainMax"
                             type="range"
                             @change="changeGain(i)"
                             @mousemove="changeGain(i)"
                             @dblclick="file.gain = 1">
                      <div class="control ml-2 is-size-7" style="font-size: inherit;">{{file.gain}}</div>
                      <div class="has-text-grey ml-2 is-size-7">（元の音量＝1）</div>
                    </div>
                    <div class="level-right">
                      <label v-if="i !== files.length - 1"
                          class="checkbox">
                        <input type="checkbox" v-model="file.continuousPlay"/>
                        <span>次を自動再生</span>
                      </label>
                    </div>
                  </nav>
                </div>
              </div>
              <!-- 再生編集ここまで -->
            </div>
          </td>
          <td class="mx-0 px-1 fitContent">
            <button class="delete" @click="removeRow(i)"></button>
          </td>
        </tr>
        </tbody>
      </table>
    </div>

    <br>
    <footer class="footer">
      <div class="content has-text-centered">
        <p>Pier Player - v{{version}}</p>
      </div>
    </footer>
  </main>
</div>


<script src="../../static/js/jquery.js"></script>
<script src="../../static/js/time.js"></script>
<script>
    fetch('../components/side-nav.html')
        .then(res => res.text())
        .then(html => {
            $('#sideMenu').replaceWith(html);
            $('#is-timeline').addClass("is-active");
        });
</script>
<script>
    new Vue({
        el: "#appTimeline",
        data: {
            files: [],
            // files: [{
            //     path: "",
            //     name: "",
            //     type: "",
            //     exists: true,
            //     //トリミング
            //     startTrimSec: 0,
            //     endTrimSec: 0,
            // }],
            dragIndex: null,
            isEnter: null,
            disallowedFileTypeMessage: "",
            videoReload: 0,
            reDraw: 0,
            version: "",
            trimStep: 0.5000,
            fadeStep: 0.1000,
            gainStep: 0.1000,
            gainMin: 0,
            gainMax: 3,
            // player
            playerMeta: {
                currentTime: 0,
                duration: null,
                loadedmetadata: false,
                isPlaying: false,
                seeking: false,
            },
        },
        async created() {
            this.version = await window.api.getVersion()

            const files = await window.timeline.getFiles();
            this.files = await window.timeline.checkFilePaths(files);
        },
        computed: {
            currentTimeColon() {
                return minSecColonFrom(this.playerMeta.currentTime)
            },
            durationColon() {
                return minSecColonFrom(this.playerMeta.duration)
            },
            progress() {
                if (!this.playerMeta.currentTime) return 0
                if (!this.playerMeta.duration) return 0
                return (this.playerMeta.currentTime / this.playerMeta.duration) * 100;
            },
            playingFileIndex() {
                return this.files.findIndex(file => file.isPlaying);
            },
        },
        mounted() {
            this.playerHooks()
        },
        watch: {
            files: {
                handler: function (newFiles, oldFiles) {
                    window.timeline.storeFiles(newFiles);
                },
                deep: true
            },
        },
        methods: {
            async selectFile(file) {
                const path = window.webUtils.getPathForFile(file)
                const checkedFile = await window.timeline.checkFilePath({
                    path: path,
                    name: file.name,
                    type: file.type,
                    exists: true,
                    startTrimSec: 0,
                    endTrimSec: 0,
                    startFadeSec: 0.7,
                    endFadeSec: 0.7,
                    gain: 1,
                });

                this.files.push(checkedFile)
            },
            selectVideoFile(event) {
                this.selectFile(event.target.files[0])
            },
            selectAudioFile(event) {
                this.selectFile(event.target.files[0])
            },
            isValidFilePath(path) {
            },
            isVideo(type) {
                return type.match(/video\/.*/)
            },
            isAudio(type) {
                return type.match(/audio\/.*/)
            },
            allowedFileType(type) {
                return this.isVideo(type) || this.isAudio(type)
            },
            openFolder(filePath) {
                // 正規表現で最後の「\ファイル名」を削除
                const folderPath = filePath.replace(/[\\/][^\\/]+$/, "");
                window.timeline.openFolder(folderPath);
            },
            //トリミング
            increaseStartTrim(i) {
                const file = this.files[i]
                file.startTrimSec = this.increase(file.startTrimSec, this.trimStep)
                this.reDraw++
            },
            decreaseStartTrim(i) {
                const file = this.files[i]
                file.startTrimSec = this.decrease(file.startTrimSec, this.trimStep)
                this.reDraw++
            },
            increaseEndTrim(i) {
                const file = this.files[i]
                file.endTrimSec = this.increase(file.endTrimSec, this.trimStep)
                this.reDraw++
            },
            decreaseEndTrim(i) {
                const file = this.files[i]
                file.endTrimSec = this.decrease(file.endTrimSec, this.trimStep)
                this.reDraw++
            },
            //フェード
            increaseStartFade(i) {
                const file = this.files[i]
                file.startFadeSec = this.increase(file.startFadeSec, this.fadeStep)
                this.reDraw++
            },
            decreaseStartFade(i) {
                const file = this.files[i]
                file.startFadeSec = this.decrease(file.startFadeSec, this.fadeStep)
                this.reDraw++
            },
            increaseEndFade(i) {
                const file = this.files[i]
                file.endFadeSec = this.increase(file.endFadeSec, this.fadeStep)
                this.reDraw++
            },
            decreaseEndFade(i) {
                const file = this.files[i]
                file.endFadeSec = this.decrease(file.endFadeSec, this.fadeStep)
                this.reDraw++
            },
            changeGain(i) {
                const file = this.files[i]
                window.timeline.mainPlayer.fileMetaChange(file);
            },
            sliderBackground(value) {
                const activeColor = "darkgray";
                const inactiveColor = "transparent";
                const ratio = (value - this.gainMin) / (this.gainMax - this.gainMin) * 100;
                const barColor = `linear-gradient(90deg, ${activeColor} ${ratio}%, ${inactiveColor} ${ratio}%)`;

                const percent = (1 / this.gainMax - this.gainMin) * 100; // デフォルト値1の位置（min=0, max=3）
                const defaultLine = `
                  linear-gradient(to right,
                    transparent ${percent - 1}%,
                    gray ${percent - 1}%,
                    gray ${percent + 1}%,
                    transparent ${percent + 1}%)
                `;

                return `${defaultLine}, ${barColor}`
            },
            increaseGain(i) {
                const file = this.files[i]
                file.gain = this.increase(file.gain, this.gainStep, 3.0)
                if (file.gain > 3) file.gain = 3.0
                this.reDraw++
                window.timeline.mainPlayer.fileMetaChange(file);
            },
            decreaseGain(i) {
                const file = this.files[i]
                file.gain = this.decrease(file.gain, this.gainStep)
                this.reDraw++
                window.timeline.mainPlayer.fileMetaChange(file);
            },
            increase(sec, step, max = null) {
                if (!sec) return step
                if (max && sec >= max) return max
                const newSec = Number(sec) + step
                return Math.round(newSec * 1000) / 1000
            },
            decrease(sec, step, min = 0) {
                if (!sec) return min
                if (sec <= min) return min
                const newSec = Number(sec) - step
                return Math.round(newSec * 1000) / 1000
            },
            start(i) {
                this.closeStatusAll()

                // this.isPlaying = true;
                const file = this.files[i]
                file.isPlaying = true;

                window.timeline.openSubWindow(file)
                    .then((isExists) => {
                        if (!isExists) {
                            // this.isPlaying = false;
                            alert(`ファイルが開けませんでした。\n「${file.name}」`)
                            file.isPlaying = false;
                        }
                        this.reDraw++
                    })
            },
            close(i) {
                const file = this.files[i]
                window.timeline.closeSubWindow();
                file.isPlaying = false
                this.reDraw++
                this.playerMeta.currentTime = 0
                this.playerMeta.isPlaying = false
            },
            // close() {
            //     window.timeline.closeSubWindow();
            //     // this.isPlaying = false
            // },
            closeStatusAll() {
                window.timeline.closeSubWindow();
                this.files.forEach((file) => {
                    file.isPlaying = false
                })
                this.reDraw++
            },
            reset() {
                this.closeStatusAll()
                this.playerMeta.currentTime = 0
            },
            addRow() {
                this.files.push({path: "", name: "", type: ""})
            },
            removeRow(i) {
                this.files.splice(i, 1);
            },
            dragStart(index) {
                if (this.playerMeta.isPlaying) return alert("再生中は順番を変えられません")
                this.dragIndex = index;
            },
            dragEnter(index) {
                if (this.playerMeta.isPlaying) return alert("再生中は順番を変えられません")
                if (index === this.dragIndex) return;
                const deleteElement = this.files.splice(this.dragIndex, 1)[0];
                this.files.splice(index, 0, deleteElement);
                this.dragIndex = index;
            },
            dragEnd() {
                this.dragIndex = null;
            },
            dragDropEnter() {
                this.isEnter = true;
            },
            dragDropLeave() {
                this.isEnter = false;
            },
            droppedFile(event) {
                this.disallowedFileTypeMessage = ""
                this.isEnter = false;

                const file = event.dataTransfer.files[0]
                if (!this.allowedFileType(file.type))
                    return this.disallowedFileTypeMessage = "動画か音源ファイルのみ追加可能です。"

                return this.selectFile(file)
            },
            isExists(v) {
                return typeof v !== 'undefined' && v !== null && v !== "" && v !== {};
            },
            // player
            restart: () => window.timeline.mainPlayer.restart(),
            rewind: (seekTime) => window.timeline.mainPlayer.rewind(seekTime),
            play: () => window.timeline.mainPlayer.play(),
            pause: () => window.timeline.mainPlayer.pause(),
            forward: (seekTime) => window.timeline.mainPlayer.forward(seekTime),
            toEnd: () => window.timeline.mainPlayer.toEnd(),
            startSeek(e) {
                this.playerMeta.seeking = true;
                this.updateSeek(e);

                // ドキュメント全体で mousemove / mouseup を監視
                document.addEventListener('mousemove', this.updateSeek);
                document.addEventListener('mouseup', this.stopSeek);
                document.addEventListener('mouseleave', this.stopSeek);
            },
            updateSeek(e) {
                if (!this.playerMeta.seeking) return;
                const rect = e.srcElement.getBoundingClientRect();
                const clickX = e.clientX - rect.left; // クリック位置
                let ratio = clickX / rect.width;   // 全体に対する割合
                ratio = Math.max(0, Math.min(1, ratio)); // 0~1に制限
                const newTime = Math.round(ratio * this.playerMeta.duration);
                this.playerMeta.currentTime = newTime
                window.timeline.mainPlayer.seek(newTime)
            },
            stopSeek() {
                this.playerMeta.seeking = false;
                document.removeEventListener('mousemove', this.updateSeek);
                document.removeEventListener('mouseup', this.stopSeek);
                document.removeEventListener('mouseleave', this.stopSeek);
            },
            playerHooks() {
                window.timeline.listener.ready((event, param) => {
                })
                window.timeline.listener.duration((event, param) => {
                    this.playerMeta.duration = param.duration
                    this.playerMeta.loadedmetadata = true
                })
                window.timeline.listener.play((event, param) => {
                    console.log("play")
                    this.playerMeta.isPlaying = true
                })
                window.timeline.listener.timeupdate((event, param) => {
                    this.playerMeta.currentTime = param.currentTime
                })
                window.timeline.listener.paused((event, param) => {
                    console.log("paused")
                    this.playerMeta.isPlaying = false
                })
                window.timeline.listener.ended((event, param) => {
                    console.log("end")
                    const index = this.playingFileIndex;
                    const isLastFile = index !== this.files.length - 1
                    if (isLastFile) return

                    const playingFile = this.files[index];
                    if (playingFile.continuousPlay) this.start(index + 1)
                })
            },
        },
    })
</script>
</body>
</html>